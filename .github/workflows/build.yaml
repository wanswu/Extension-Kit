name: Build and Release Extension-Kit  

on:  
  push:  
    branches: [ main, dev ]  
  pull_request:  
    branches: [ main ]  
  release:  
    types: [created]  

jobs:  
  build:  
    runs-on: ubuntu-latest  

    steps:  
    - uses: actions/checkout@v3  

    - name: Install MinGW  
      run: |  
        sudo apt-get update  
        sudo apt-get install -y make mingw-w64 python3

    - name: Build BOFs  
      run: |  
        make

    - name: Package Release  
      run: |  
        mkdir -p release  
        find . -name "*.o" -exec cp {} release/ \;  
        find . -name "*_beacon.json" -exec cp {} release/ \;  
        tar -czf extension-kit-${{ github.sha }}.tar.gz release/  

    - name: Upload to GitHub Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }} # 假设在 release 事件触发
        asset_path: extension-kit-${{ github.sha }}.tar.gz
        asset_name: extension-kit-${{ github.sha }}.tar.gz
        asset_content_type: application/gzip